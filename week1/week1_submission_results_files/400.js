define(function(require){var CONSTANTS={activityExpirationTime:18e5,beacon:"https://www.coursera.org/eventing/info.v2",initialReferrerTracker:"__400r",visitIdTracker:"__400v",lastActivityTimeTracker:"__400vt",maxGetSize:4e3,cookieIdTracker:"__204u"},generateUUID=function(){var d=(new Date).getTime(),uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:7&r|8).toString(16)});return uuid},serializeVal=function(val){return"string"!=typeof val&&window.JSON?window.JSON.stringify(val):val.toString()},serialize=function(data){var params=[];for(var key in data)params.push(key+"="+encodeURIComponent(serializeVal(data[key])));if(!window.JSON)params.push("_noJSON_=true");return params.join("&")},noop=function(_){return _},post=function(beacon,data,callback){var iframe=document.createElement("iframe"),frameId=generateUUID();document.body.appendChild(iframe),iframe.style.display="none",iframe.name=frameId,iframe.contentWindow.name=frameId;var div=document.createElement("div");div.style.display="none;",document.body.appendChild(div);var form=document.createElement("form");form.target=frameId,form.action=beacon,form.method="POST",div.appendChild(form);var input;for(var key in data)input=document.createElement("input"),input.type="hidden",input.name=key,input.value=serializeVal(data[key]),form.appendChild(input);iframe.onload=iframe.onreadystatechange=function(){if(!this.readyState||"complete"===this.readyState)if(iframe.onreadystatechange=iframe.onload=null,iframe.parentNode.removeChild(iframe),form.parentNode.removeChild(form),callback&&"function"==typeof callback)callback()},form.submit()},get=function(beacon,data,callback){var script=document.createElement("script");script.type="text/javascript",script.async=!0,script.src=beacon+"?"+serialize(data),script.onload=script.onreadystatechange=function(){if(!this.readyState||"complete"===this.readyState)if(script.onreadystatechange=script.onload=null,script.parentNode.removeChild(script),callback&&"function"==typeof callback)callback()},document.head.appendChild(script)},ping=function(beacon,data,callback){if(serialize(data).length<CONSTANTS.maxGetSize)get(beacon,data,callback);else post(beacon,data,callback)},cookie={set:function(key,value,options){options=options||{};var currentTime=new Date;if(null===value||void 0===value)options.days=-1;if("number"==typeof options.days)currentTime.setDate(currentTime.getDate()+options.days),options.expires=currentTime;else if("number"==typeof options.minutes)currentTime.setMinutes(currentTime.getMinutes()+options.minutes),options.expires=new Date(currentTime);if(!options.path)options.path="/";var encode=options.raw?noop:encodeURIComponent,cookie=encode(key)+"="+encode(String(value))+"; path="+options.path;if(options.expires)cookie+="; expires="+options.expires.toUTCString();if(options.domain)cookie+="; domain="+options.domain;if(options.secure)cookie+="; secure";return document.cookie=cookie,cookie},setOnce:function(key,value,options){var currentValue=cookie.get(key,options);if(null===currentValue)cookie.set(key,value,options),currentValue=value;return currentValue},get:function(key,options){options=options||{};for(var decode=options.raw?noop:decodeURIComponent,pairs=document.cookie.split("; "),i=0,pair;pairs[i];i++)if(pair=pairs[i].split("="),decode(pair[0])===key){var val=decode(pair[1]||"");return"null"===val?null:val}return null},remove:function(key,options){options=options||{},options.days=-1,cookie.set(key,null,options)},removeAll:function(keys,options){for(var i=keys.length;i>=0;i--)cookie.remove(keys[i],options)}},isActivityTimeExpired=function(activityTime){if(!activityTime)return!0;if((new Date).getTime()-activityTime>CONSTANTS.activityExpirationTime)return!0;return!1},FourHundred=function(){this.constants=CONSTANTS,this.state={},this.state.domain=this.getDomain(),this.getCurrentInitialReferrer(),this.getCurrentVisitId(),this.state.cookieId=this.getCookieId(),this.state.screenSize={height:this.windowHelper.screenHeight(),width:this.windowHelper.screenWidth()},this.updateLastActivityTime()};return FourHundred.prototype.getCookieId=function(id){var cookieOptions={domain:this.state.domain,days:365};return cookie.get(this.constants.cookieIdTracker,cookieOptions)},FourHundred.prototype.getDomain=function(){for(var parts=this.windowHelper.hostname().split(".");parts.length>2;)parts.shift();return"."+parts.join(".")},FourHundred.prototype.getCurrentInitialReferrer=function(){var cookieOptions={domain:this.state.domain,minutes:30};this.state.initialReferrer=this.state.initialReferrer||cookie.get(this.constants.initialReferrerTracker);var lastActivityTime=this.state.lastActivityTime||cookie.get(this.constants.lastActivityTimeTracker);if(!this.state.initialReferrer||isActivityTimeExpired(lastActivityTime)){var from=this.windowHelper.referrer();if(!from)return;var domainRegEx=/([a-z0-9-_]+\.)*[a-z0-9-_]+\.[a-z]+/gi,domains=from.match(domainRegEx),currentHostArr=this.state.domain.split("."),currentHost=currentHostArr[currentHostArr.length-2]+"."+currentHostArr[currentHostArr.length-1];if(domains[0].indexOf(currentHost)>-1)from=null;cookie.set(this.constants.initialReferrerTracker,from,cookieOptions),this.state.initialReferrer=from}return this.state.initialReferrer},FourHundred.prototype.getCurrentVisitId=function(){var cookieOptions={domain:this.state.domain,minutes:30};this.state.visitId=this.state.visitId||cookie.get(this.constants.visitIdTracker);var lastActivityTime=this.state.lastActivityTime||cookie.get(this.constants.lastActivityTimeTracker);if(!this.state.visitId||isActivityTimeExpired(lastActivityTime)){var id=generateUUID();cookie.set(this.constants.visitIdTracker,id,cookieOptions),this.state.visitId=id}return this.state.visitId},FourHundred.prototype.updateLastActivityTime=function(){var time=(new Date).getTime(),cookieOptions={domain:this.state.domain,minutes:30};cookie.set(this.constants.lastActivityTimeTracker,time,cookieOptions),this.state.lastActivityTime=time},FourHundred.prototype.push=function(command){if("object"!=typeof command)return this;if(Array.isArray&&Array.isArray(command)||command.constructor===Array)switch(command[0]){case"send":this.send(command[1],command[2]);break;default:this.state[command[0]]=command[1]}else this.send(command);return this},FourHundred.prototype.send=function(data,callback){if("string"==typeof data)data={key:data};else data=data||{};data.clientType="web",data.url=this.windowHelper.href(),data.cookieId=this.state.cookieId||this.getCookieId(),data.app=this.state.app,data.referrerUrl=this.windowHelper.referrer(),data.initialReferrer=this.getCurrentInitialReferrer(),data.guid=generateUUID(),data.visitId=this.getCurrentVisitId(),data.screenSize=this.state.screenSize,data.clientVersion=this.state.clientVersion;for(var key in data)if(null===data[key]||""===data[key]||void 0===data[key])delete data[key];return this.ping(this.constants.beacon,data,callback),this.updateLastActivityTime(),this},FourHundred.prototype.batch=function(batch){for(;batch.length;){var trackEvent=this.parse(batch.shift());this.push(trackEvent)}return this},FourHundred.prototype.parse=function(tracking){var trackEvent,value=tracking[1];if("object"==typeof value&&value.v2===!0)delete value.v2,trackEvent={key:tracking[0],value:window.JSON.stringify(value)};return trackEvent},FourHundred.prototype.cookie=cookie,FourHundred.prototype.post=post,FourHundred.prototype.ping=ping,FourHundred.prototype.windowHelper={hostname:function(){return window.location.hostname},href:function(){return window.location.href},referrer:function(){return window.document.referrer},screenHeight:function(){return window.screen.height},screenWidth:function(){return window.screen.width}},new FourHundred});